<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" href="https://www.patternsgameprog.com/discover-python-and-patterns-19-mouse" />
<meta name="description" content="Mouse handling with Python and Pygame.">
<meta name="author" content="Philippe-Henri Gosselin">
<meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />
<link rel="icon" href="assets/img/favicon.ico">
<title>Design Patterns and Video Games</title>
<link href="https://www.patternsgameprog.com/assets/css/bootstrap.min.css" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">
<link href="https://www.patternsgameprog.com/assets/css/mediumish.css" rel="stylesheet">
<link href="https://www.patternsgameprog.com/assets/css/darcula.css" rel="stylesheet">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-150349446-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-150349446-1');
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NB1HVSF9XH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NB1HVSF9XH');
</script>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

</head>
<body>

<!-- Begin Nav
================================================== -->
<nav class="navbar navbar-toggleable-md navbar-light bg-white fixed-top mediumnavigation">
<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="container">
	<a class="navbar-brand" href="https://www.patternsgameprog.com">
	Design Patterns and Video Games
	</a>
	
	<div class="collapse navbar-collapse" id="navbarsExampleDefault">
		<ul class="navbar-nav ml-auto">
						<li class="nav-item">
			<a class="nav-link" href="https://www.patternsgameprog.com/series">Series</a>
			</li>
						<li class="nav-item">
			<a class="nav-link" href="https://www.patternsgameprog.com/more">More</a>
			</li>
						<li class="nav-item">
			<a class="nav-link" href="https://www.patternsgameprog.com/about">About</a>
			</li>
									
		</ul>
	</div>
</div>
</nav>
<!-- End Nav
================================================== -->



<div class="container">
	<div class="mainheading">
		<img class="featured-image img-fluid" src="https://www.patternsgameprog.com/assets/img/header.png" alt="Design Patterns and Video Games">
	</div>
<!-- End Site Title
================================================== -->

	<div class="section-title">
		<h2><span>Discover Python and Patterns (19): Mouse</span></h2>
	</div>

<p>In this post, I want to use the mouse to orient the unit weapons.</p>
<p><em>This post is part of the <a href="https://www.patternsgameprog.com/series/discover-python-and-patterns/">Discover Python and Patterns series</a></em> </p>
<h2>Orient the weapons</h2>
<p>The expected result is the following. The tank weapon targets the mouse position, and the tower weapons target the tank:</p>
<!-- Video Player -->
<figure><video controls="controls" height="90%" poster="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-19-mouse/8001c60366-1622751186/19_mouse.mp4.jpg" preload="preload" width="90%"><source src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-19-mouse/7174086af1-1621709975/19_mouse.mp4" type="video/mp4"><a href="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-19-mouse/7174086af1-1621709975/19_mouse.mp4"><img src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-19-mouse/8001c60366-1622751186/19_mouse.mp4.jpg"></a></source></video></figure>
<p>Before considering the mouse handling, we need to be able to rotate the unit weapon correctly.</p>
<h2>Render a rotated tile</h2>
<h3>The renderTile() method</h3>
<p>In the <code>Layer</code> class, there is the <code>renderTile()</code> method that renders a tile from a tileset. I propose to add a new <code>angle</code> argument to this method. If this argument is not empty (not <code>None</code>), then we rotate the tile:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">renderTile</span><span class="hljs-params">(self,surface,position,tile,angle=None)</span>:</span>
    <span class="hljs-comment"># Location on screen</span>
    spritePoint = position.elementwise()*self.ui.cellSize

    <span class="hljs-comment"># Texture</span>
    texturePoint = tile.elementwise()*self.ui.cellSize
    textureRect = Rect(int(texturePoint.x), int(texturePoint.y), self.ui.cellWidth, self.ui.cellHeight)

    <span class="hljs-comment"># Draw</span>
    <span class="hljs-keyword">if</span> angle <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        surface.blit(self.texture,spritePoint,textureRect)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># Extract the tile in a surface</span>
        textureTile = pygame.Surface((self.ui.cellWidth,self.ui.cellHeight),pygame.SRCALPHA)
        textureTile.blit(self.texture,(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),textureRect)
        <span class="hljs-comment"># Rotate the surface with the tile</span>
        rotatedTile = pygame.transform.rotate(textureTile,angle)
        <span class="hljs-comment"># Compute the new coordinate on the screen, knowing that we rotate around the center of the tile</span>
        spritePoint.x -= (rotatedTile.get_width() - textureTile.get_width()) // <span class="hljs-number">2</span>
        spritePoint.y -= (rotatedTile.get_height() - textureTile.get_height()) // <span class="hljs-number">2</span>
        <span class="hljs-comment"># Render the rotatedTile</span>
        surface.blit(rotatedTile,spritePoint)</code></pre>
<p>The first lines (2-7) are as before: we compute the location on the surface (or screen) and the rectangle of the tile in the texture tileset.</p>
<p>If the angle is <code>None</code> (line 10), then we render as before (line 11).</p>
<p>Note that the <code>angle</code> argument in the method declaration (line 1) has a default value set as <code>None</code>. If we call the method without this last argument, then <code>angle</code> gets this default value.</p>
<h3>Tile rotation around its center</h3>
<p>Lines 13-22 rotate and render the tile.</p>
<p>Lines 14-15 extract the tile from the texture tileset in <code>textureTile</code>. It is a Pygame surface with the size of a cell, e.g. 64 per 64 pixels in our current implementation.</p>
<p>Line 17 rotates the tile and store the result in <code>rotatedTile</code>. This new surface can be larger than the tile. The following figure can help you better understand why (I added a black border to see the edges of the tile):</p>
<figure><img alt="Pygame rotate" class="centered-image img-fluid" src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-19-mouse/32113d57a3-1621709975/19_rotation.png" width="200"></figure>
<p>As a result, if we want to draw the rotated tile centered on the base tile, we need to update <code>spritePoint</code> coordinates: it is what lines 19-20 do.</p>
<p>Since we draw from the top left corner of the tile, we have to draw the sprite with a small shift. The following figure describes the computation on the x-axis:</p>
<figure><img alt="Pygame rotate and center" class="centered-image img-fluid" src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-19-mouse/7ed447af4c-1621709975/19_rotation_schema.png" width="330"></figure>
<p>The value of the x-shift is half the width of the rotated sprite minus the half the width of the sprite:</p>
<pre class="hljs"><code> rotatedTile.get_width()//<span class="hljs-number">2</span> - textureTile.get_width()//<span class="hljs-number">2</span></code></pre>
<p>Note the operator '//': it is the integer division. Otherwise, if you use the '/' operation, a float division is computed, which is not relevant in our case, since we need pixel coordinates.</p>
<h2>Weapon target</h2>
<p>In the <code>Unit</code> class, I propose to add a new attribute <code>weaponTarget</code>. This attribute contains the coordinates of the cell targeted by the unit weapon.</p>
<p>The <code>render()</code> method of the <code>UnitsLayer</code> class uses this attribute. It is as before, except that we compute the angle between the current unit position and the targeted cell (lines 4-5):</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span><span class="hljs-params">(self,surface)</span>:</span>
    <span class="hljs-keyword">for</span> unit <span class="hljs-keyword">in</span> self.units:
        self.renderTile(surface,unit.position,unit.tile)
        size = unit.weaponTarget - unit.position
        angle = math.atan2(-size.x,-size.y) * <span class="hljs-number">180</span> / math.pi
        self.renderTile(surface,unit.position,Vector2(<span class="hljs-number">0</span>,<span class="hljs-number">6</span>),angle)</code></pre>
<h2>Target selection</h2>
<p>We are now able to render a unit with a weapon oriented towards to any cell. We need to choose which one is targeted by each unit.</p>
<p>I first create a new <code>orientWeapon()</code> method in the <code>Unit</code> class hierarchy:</p>
<figure><img class="centered-image img-fluid" src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-19-mouse/0826a0ee0a-1621710248/19_units-768x370.png" width="512"></figure>
<p>The principle is as for the <code>move()</code> method: the implementation in the base class raises a <code>NotImplementedError</code> exception, and the implementation in the child classes is specific.</p>
<p>For the tank, we copy the <code>target</code> method argument to the <code>weaponTarget</code> attribute. Later, we use the mouse coordinates to define <code>target</code>, and the tank weapon always targets the mouse cursor:</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tank</span><span class="hljs-params">(Unit)</span>:</span>
    ...
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">orientWeapon</span><span class="hljs-params">(self,target)</span>:</span>
        self.weaponTarget = target</code></pre>
<p>For the towers, we ignore the method argument, and copy the tank position (the first unit in the list of units) to the <code>weaponTarget</code> attribute. This way, all towers weapon always target the tank:</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tower</span><span class="hljs-params">(Unit)</span>:</span>
    ...
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">orientWeapon</span><span class="hljs-params">(self,target)</span>:</span>
        self.weaponTarget = self.state.units[<span class="hljs-number">0</span>].position</code></pre>
<h2>The mouse</h2>
<p>The most challenging part is now behind us! All that remains is the use of the mouse coordinates to orient the tank weapon.</p>
<p>As before, we use a basic implementation of the Command pattern. So we need:</p>
<ul>
<li>To create a variable that stores the cell targeted by the mouse;</li>
<li>To compute the target cell coordinates;</li>
<li>To transmit this value to all units.</li>
</ul>
<p>Following this recipe, we create a new <code>targetCommand</code> attribute in the <code>UserInterface</code> class:</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserInterface</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        ...
        self.targetCommand = Vector2(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
    ...</code></pre>
<p>The <code>processInput()</code> method of the <code>UserInterface</code> class computes the target cell coordinates, and store them in the <code>targetCommand</code> attribute:</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserInterface</span><span class="hljs-params">()</span>:</span>
    ...
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processInput</span><span class="hljs-params">(self)</span>:</span>
        ...
        mousePos = pygame.mouse.get_pos()                    
        self.targetCommand.x = mousePos[<span class="hljs-number">0</span>] / self.cellWidth - <span class="hljs-number">0.5</span>
        self.targetCommand.y = mousePos[<span class="hljs-number">1</span>] / self.cellHeight - <span class="hljs-number">0.5</span> 
    ...</code></pre>
<p>The <code>pygame.mouse.get_pos()</code> function returns the mouse pixel coordinates in the window. We divide these coordinates by the size of a cell to get cell coordinates. Then, we substract 0.5 to target the center of the cell.</p>
<p>The <code>update()</code> method of the <code>UserInterface</code> class transmits all commands (move and target) to the game state:</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserInterface</span><span class="hljs-params">()</span>:</span>
    ...
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span><span class="hljs-params">(self)</span>:</span>
        self.gameState.update(self.moveTankCommand,self.targetCommand) 
    ...</code></pre>
<p>Finally, the <code>update()</code> method of the <code>GameState</code> class gives the <code>moveTankCommand</code> to the <code>move()</code> method of all units, and gives the <code>targetCommand</code> to the <code>orientWeapon()</code> method of all units. Then, each unit can use (or don't use) these commands.</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GameState</span><span class="hljs-params">()</span>:</span>
    ...
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span><span class="hljs-params">(self,moveTankCommand,targetCommand)</span>:</span>
        <span class="hljs-keyword">for</span> unit <span class="hljs-keyword">in</span> self.units:
            unit.move(moveTankCommand)
        <span class="hljs-keyword">for</span> unit <span class="hljs-keyword">in</span> self.units:
            unit.orientWeapon(targetCommand) 
    ...</code></pre>
<p>In our current implementation, only the tank uses the commands, and the towers ignore them. Try to change it, for instance, let all towers target the mouse cursor or one of the towers. To get such results, you only need to change the <code>orientWeapon()</code> method of the <code>Tower</code> class.</p>
<h2>Final program</h2>
<p>In the final program, I also added an <code>orientation</code> attribute to units, so the base of each unit can be oriented. I use this attribute to orient the tank base towards its current move.</p>
<p><a href="https://www.patternsgameprog.com/discover-python-and-patterns-19-mouse/discover_python_and_patterns_19_mouse.zip">Download program and assets</a></p>
<p>The current implementation of the Command pattern has many flaws. Now we saw class inheritance, I'll be able to show you a better implementation in the <a href="https://www.patternsgameprog.com/discover-python-and-patterns-20-better-commands/">next post</a>.</p>
	<!-- Begin Footer
	================================================== -->
	<div class="footer">
		<p class="pull-left">
			 Copyright &copy; 2020-2023 https://www.patternsgameprog.com
		</p>
		<p class="pull-right">
			<a href="https://twitter.com/umlgameprog?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @umlgameprog</a></script>
		</p>
		<div class="clearfix">
		</div>
	</div>
	<!-- End Footer
	================================================== -->

</div>
<!-- /.container -->

<!-- Bootstrap core JavaScript
    ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://www.patternsgameprog.com/assets/js/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://www.patternsgameprog.com/assets/js/bootstrap.min.js"></script>
<script src="https://www.patternsgameprog.com/assets/js/ie10-viewport-bug-workaround.js"></script>
<script src="https://www.patternsgameprog.com/assets/js/mediumish.js"></script>
</body>
</html>