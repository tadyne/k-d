<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" href="https://www.patternsgameprog.com/discover-python-and-patterns-27-music-and-sounds" />
<meta name="description" content="Music and sound with Python and Pygame.">
<meta name="author" content="Philippe-Henri Gosselin">
<meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />
<link rel="icon" href="assets/img/favicon.ico">
<title>Design Patterns and Video Games</title>
<link href="https://www.patternsgameprog.com/assets/css/bootstrap.min.css" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">
<link href="https://www.patternsgameprog.com/assets/css/mediumish.css" rel="stylesheet">
<link href="https://www.patternsgameprog.com/assets/css/darcula.css" rel="stylesheet">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-150349446-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-150349446-1');
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NB1HVSF9XH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NB1HVSF9XH');
</script>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

</head>
<body>

<!-- Begin Nav
================================================== -->
<nav class="navbar navbar-toggleable-md navbar-light bg-white fixed-top mediumnavigation">
<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="container">
	<a class="navbar-brand" href="https://www.patternsgameprog.com">
	Design Patterns and Video Games
	</a>
	
	<div class="collapse navbar-collapse" id="navbarsExampleDefault">
		<ul class="navbar-nav ml-auto">
						<li class="nav-item">
			<a class="nav-link" href="https://www.patternsgameprog.com/series">Series</a>
			</li>
						<li class="nav-item">
			<a class="nav-link" href="https://www.patternsgameprog.com/more">More</a>
			</li>
						<li class="nav-item">
			<a class="nav-link" href="https://www.patternsgameprog.com/about">About</a>
			</li>
									
		</ul>
	</div>
</div>
</nav>
<!-- End Nav
================================================== -->



<div class="container">
	<div class="mainheading">
		<img class="featured-image img-fluid" src="https://www.patternsgameprog.com/assets/img/header.png" alt="Design Patterns and Video Games">
	</div>
<!-- End Site Title
================================================== -->

	<div class="section-title">
		<h2><span>Discover Python and Patterns (27): Music and Sounds</span></h2>
	</div>

<p>In this post, I add music and sounds to our tank game and make use of the Observer pattern to implement it efficiently.</p>
<p><em>This post is part of the <a href="https://www.patternsgameprog.com/series/discover-python-and-patterns/">Discover Python and Patterns series</a></em></p>
<h2>Objective</h2>
<p>The objectives are the following:</p>
<ul>
<li>Play a piece of music when the game starts;</li>
<li>Play a piece of music when a level is loaded;</li>
<li>Play a piece of music when the player wins;</li>
<li>Play a piece of music when the player loses;</li>
<li>Play a sound when a unit fires;</li>
<li>Play a sound when a unit is destroyed.</li>
</ul>
<!-- Video Player -->
<figure><video controls="controls" height="90%" poster="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-27-music-and-sounds/aec806f706-1622751207/27_audio.mp4.jpg" preload="preload" width="90%"><source src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-27-music-and-sounds/982239ee3d-1621710972/27_audio.mp4" type="video/mp4"><a href="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-27-music-and-sounds/982239ee3d-1621710972/27_audio.mp4"><img src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-27-music-and-sounds/aec806f706-1622751207/27_audio.mp4.jpg"></a></source></video></figure>
<p>The pieces of music from <a href="https://www.freesfx.co.uk">https://www.freesfx.co.uk</a>, and are all royalty-free (<a href="https://www.freesfx.co.uk/Music.aspx">https://www.freesfx.co.uk/Music.aspx</a>). I keep the original file names to better credit the authors:</p>
<ul>
<li>"17718_1462204250.mp3": Menu music, called "Gang War";</li>
<li>"17687_1462199612.mp3": Level music, called "Military Madness";</li>
<li>"17382_1461858477.mp3": Victory music, called "Opening Day";</li>
<li>"17675_1462199580.mp3": Game over music, called "Deadly Talk".</li>
</ul>
<p>The sounds come from <a href="https://freesound.org">https://freesound.org</a>, and their license is Attribution-NonCommercial 3.0 Unported (<a href="https://creativecommons.org/licenses/by-nc/3.0/">https://creativecommons.org/licenses/by-nc/3.0/</a>). I also keep the original file names to better credit the authors:</p>
<ul>
<li>"170274<strong>knova</strong>rifle-fire-synthetic.wav": Bullet fire sound, created by knova (<a href="https://freesound.org/people/knova/">https://freesound.org/people/knova/</a>);</li>
<li>"110115<strong>ryansnook</strong>small-explosion.wav": Explosion sound, created by ryansnook (<a href="https://freesound.org/people/ryansnook/">https://freesound.org/people/ryansnook/</a>).</li>
</ul>
<h2>Music with Pygame</h2>
<p>It is easy to play a piece of music with Pygame. Firstly, load the music file using the <code>pygame.mixer.music.load()</code> function:</p>
<pre class="hljs"><code>pygame.mixer.music.load(<span class="hljs-string">"music.mp3"</span>)</code></pre>
<p>Note that it stops any music already playing. Also, note that you can only have one piece at a time.</p>
<p>Once the music file is loaded, you can start it using the <code>pygame.mixer.music.play()</code> function. This function has several optional arguments. In our case, we set <code>loops</code> to -1 to repeat indefinitely:</p>
<pre class="hljs"><code>pygame.mixer.music.play(loops=<span class="hljs-number">-1</span>)   </code></pre>
<p>You can find more details here: <a href="https://www.pygame.org/docs/ref/music.html">https://www.pygame.org/docs/ref/music.html</a>.</p>
<p>In the constructor of the <code>UserInterface</code> class, we add to two following lines to get a piece of music playing at the beginning of the game:</p>
<pre class="hljs"><code>pygame.mixer.music.load(<span class="hljs-string">"17718_1462204250.mp3"</span>)
pygame.mixer.music.play(loops=<span class="hljs-number">-1</span>)</code></pre>
<p>Copy and paste these lines at the beginning of a Pygame program, update the music file, run, and listen!</p>
<h2>Play a sound with Pygame</h2>
<p>On the contrary to the music, you can load and store several sounds in Python variables using the <code>pygame.mixer.Sound</code> class constructor. For instance:</p>
<pre class="hljs"><code>fireSound = pygame.mixer.Sound(<span class="hljs-string">"fire.wav"</span>)
explosionSound = pygame.mixer.Sound(<span class="hljs-string">"explosion.wav"</span>)</code></pre>
<p>Then, use the <code>play()</code> method of the <code>pygame.mixer.Sound</code> class to play the sound:</p>
<pre class="hljs"><code>fireSound.play()</code></pre>
<p>You can play several sounds at the same time. There are many other methods, like the <code>set_volume()</code> method that sets the volume of the sound. You can find more details here: <a href="https://www.pygame.org/docs/ref/mixer.html#pygame.mixer.Sound">https://www.pygame.org/docs/ref/mixer.html#pygame.mixer.Sound</a>.</p>
<h2>A naive approach</h2>
<p>A naive way to trigger music changes or sounds playing is to repeat the two previous lines when something is modified. For instance, at the end of the <code>update()</code> method of the <code>PlayGameMode</code> class, when we evaluate if the game is over, we could immediately change the music:</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> self.playerUnit.status != <span class="hljs-string">"alive"</span>:
    self.gameOver = <span class="hljs-literal">True</span>
    pygame.mixer.music.load(<span class="hljs-string">"17675_1462199580.mp3"</span>)
    pygame.mixer.music.play(loops=<span class="hljs-number">-1</span>) 
<span class="hljs-keyword">else</span>:
    oneEnemyStillLives = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">for</span> unit <span class="hljs-keyword">in</span> self.gameState.units:
        <span class="hljs-keyword">if</span> unit == self.playerUnit:
            <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">if</span> unit.status == <span class="hljs-string">"alive"</span>:
            oneEnemyStillLives = <span class="hljs-literal">True</span>
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> oneEnemyStillLives:
        self.gameOver = <span class="hljs-literal">True</span>
        pygame.mixer.music.load(<span class="hljs-string">"17382_1461858477.mp3"</span>)
        pygame.mixer.music.play(loops=<span class="hljs-number">-1</span>) </code></pre>
<p>It works fine, but we introduce a dependency between the game updates and the user interface. As you should know, in software design, we don't like dependencies and try to avoid them as much as possible.</p>
<p>Imagine that we want to create a multiplayer version of our game. In this case, there is a game server that runs the updates. This server has no screen and no user interface. With the naive approach, if we do nothing, the server plays music! Even if it works fine, it uses CPU and disk I/O unnecessarily.</p>
<p>We could patch the code to add a condition to play music, like <code>if self.playMusic: ...</code>. It is a small example, but in real cases, there are thousands of such triggers. We would lose a lot of time and risk to forget to patch some lines.</p>
<p>They are also many other examples like this one, and as usual, I invite you to trust the many developers that faced them. They finally created solutions like the one I present in the next section.</p>
<h2>Sounds with the Observer pattern</h2>
<p>The Observer pattern allows us to remove the dependency between modules while creating links between them. These links are dynamics, and the observed one does not have to worry about who observes it.</p>
<p>We already used it with the game state:</p>
<figure><img alt="Game state observer" class="centered-image img-fluid" src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-27-music-and-sounds/ef7a496c58-1621710972/22_game_observer-1024x196.png" width="679"></figure>
<p>The game state can notify any observer (or listener) that a unit is destroyed. Currently, the <code>ExplosionLayer</code> class observes the <code>GameState</code> class, and when it receives this notification, it starts an explosion.</p>
<p>We can add a new <code>bulletFired()</code> method to our observer scheme to handle bullet shots:</p>
<figure><img alt="Game state observer" class="centered-image img-fluid" src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-27-music-and-sounds/b109b8838d-1621710972/27_game_observer-1024x223.png" width="668"></figure>
<p>Then, in the <code>ShootCommand</code> class, we call the <code>notifyBulletFired()</code> method of the <code>GameState</code> class to indicate that a bullet is fired.</p>
<p>At this point, anyone observing the game state can know when a unit is destroyed, and when a bullet is fired.</p>
<h3>Sound layer</h3>
<p>For the sound case, I propose to create a new <code>SoundLayer</code> class, child of the <code>Layer</code> class:</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SoundLayer</span><span class="hljs-params">(Layer)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self,fireFile,explosionFile)</span>:</span>
        self.fireSound = pygame.mixer.Sound(fireFile)
        self.fireSound.set_volume(<span class="hljs-number">0.2</span>)
        self.explosionSound = pygame.mixer.Sound(explosionFile)
        self.explosionSound.set_volume(<span class="hljs-number">0.2</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unitDestroyed</span><span class="hljs-params">(self,unit)</span>:</span>
        self.explosionSound.play()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bulletFired</span><span class="hljs-params">(self,unit)</span>:</span>
        self.fireSound.play()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span><span class="hljs-params">(self,surface)</span>:</span>
        <span class="hljs-keyword">pass</span></code></pre>
<p>Even if this layer does not render anything, we can also consider it as one of the blocks that create the multimedia user experience. If you don't like that, you can create two branches, for instance, a <code>VisualLayer</code> base class for visual layers, and an <code>AudioLayer</code> base class for audio layers.</p>
<p>The implementation of this class is straightforward:</p>
<ul>
<li>It loads the sounds in the constructor (lines 3-6). Note that I choose to reduce the volume to put music in front. We could also add options in the menu to let the player set that;</li>
<li>It plays the explosion sound when a unit is destroyed (line 9);</li>
<li>It plays the fire sound when a bullet is fired (line 12).</li>
</ul>
<p>It seems that Pygame handles well the playing of many sounds. If it was not the case, we could handle it easily in this class, for instance, using a delay or a maximum number of simultaneous sounds. It would be easy because we use the Observer pattern. Otherwise, we would have to carry these values (delay or maximum) in many places in the program! A true nightmare, trust me!</p>
<h3>Observe the game state</h3>
<p>If we add the sound layer to the list of layers in the constructor of the <code>PlayGameMode</code> class, then it will observe the game state thanks to the lines right after:</p>
<pre class="hljs"><code>self.layers = [
    ArrayLayer(self.cellSize,<span class="hljs-string">"ground.png"</span>,self.gameState,self.gameState.ground,<span class="hljs-number">0</span>),
    ArrayLayer(self.cellSize,<span class="hljs-string">"walls.png"</span>,self.gameState,self.gameState.walls),
    UnitsLayer(self.cellSize,<span class="hljs-string">"units.png"</span>,self.gameState,self.gameState.units),
    BulletsLayer(self.cellSize,<span class="hljs-string">"explosions.png"</span>,self.gameState,self.gameState.bullets),
    ExplosionsLayer(self.cellSize,<span class="hljs-string">"explosions.png"</span>),
    SoundLayer(<span class="hljs-string">"170274__knova__rifle-fire-synthetic.wav"</span>,<span class="hljs-string">"110115__ryansnook__small-explosion.wav"</span>)
]

<span class="hljs-comment"># All layers listen to game state events</span>
<span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> self.layers:
    self.gameState.addObserver(layer)</code></pre>
<p>Run the game with these changes, and the game now has sounds :)</p>
<h2>Music with the Observer pattern</h2>
<p>Music changes are on a higher level than the game updates. For instance, it can happen between game creation and destruction. As a result, I propose to apply the Observer pattern on the game modes:</p>
<figure><img alt="Game mode observer" class="centered-image img-fluid" src="https://www.patternsgameprog.com/media/pages/discover-python-and-patterns-27-music-and-sounds/e2ca175e0d-1621710972/27_mode_observer-1024x313.png" width="687"></figure>
<p>There are many cases to handle and as many methods. Please don't be afraid of the number of these methods. There is software that automatically creates these methods and their implementation. If you don't want to use them or can't afford them, you can implement processes of your own. It especially easy with Python because the standard library already contains a code parser and updater that works very fine for this kind of refactoring.</p>
<h3>Factual and request events</h3>
<p>There are two kinds of events: the factual ones and the request ones. The factual ones indicate that we changed something, like <code>worldSizeChanged()</code>.</p>
<p>The request ones are queries: maybe we didn't change anything, but we would like something to happen, and we can't do it ourselves. For instance, the <code>showMenuRequested()</code> event means that we would like that the menu pops up, but we can't do it. For instance, the game is running, and the player hits the escape key.</p>
<p>Since the game is running, it means that the <code>PlayGameMode</code> is active and captures the key events. The player hits the escape key, meaning that (s)he wants to get the menu. The <code>PlayGameMode</code> class must not handle that, because it involves a higher level in the user interface since it destroys and creates modes, including the play game mode. In the previous program, we already delegated this to the <code>UserInterface</code> class thanks to its <code>showMenu()</code> method.</p>
<p>Calling a method of the <code>UserInterface</code> in the <code>PlayGameMode</code> is creating a circular dependency. Instead, the <code>PlayGameMode</code> calls the <code>notifyShowMenuRequested()</code> method. If we let the <code>UserInterface</code> listen to the <code>PlayGameMode</code>, then it can show the menu. Since it is a request, there is no warranty that someone will fulfill it.</p>
<h3>Implementation</h3>
<p>In many cases, the implementation is straightforward: we replace the call to a method of the <code>UserInterface</code> by a notification. For instance, in the <code>processInput()</code> method of the <code>MessageGameMode</code> class, we replace <code>self.ui.quitGame()</code> by <code>self.notifyQuitRequested()</code> and <code>self.ui.showMenu()</code> by <code>self.notifyShowMenuRequested()</code></p>
<pre class="hljs"><code><span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> pygame.event.get():
    <span class="hljs-keyword">if</span> event.type == pygame.QUIT:
        self.notifyQuitRequested()
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">elif</span> event.type == pygame.KEYDOWN:
        <span class="hljs-keyword">if</span> event.key == pygame.K_ESCAPE \
        <span class="hljs-keyword">or</span> event.key == pygame.K_SPACE \
        <span class="hljs-keyword">or</span> event.key == pygame.K_RETURN:
            self.notifyShowMenuRequested() </code></pre>
<p><code>GameMode</code> child classes no more have a <code>ui</code> attribute that points to the <code>UserInterface</code> class. We removed the dependency.</p>
<p>For the other cases, where something happens, we update the user interface and change the music when necessary. For instance, when the game is lost or won:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gameWon</span><span class="hljs-params">(self)</span>:</span>
    self.showMessage(<span class="hljs-string">"Victory !"</span>)
    pygame.mixer.music.load(<span class="hljs-string">"17382_1461858477.mp3"</span>)
    pygame.mixer.music.play(loops=<span class="hljs-number">-1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gameLost</span><span class="hljs-params">(self)</span>:</span>
    self.showMessage(<span class="hljs-string">"GAME OVER"</span>)
    pygame.mixer.music.load(<span class="hljs-string">"17675_1462199580.mp3"</span>)
    pygame.mixer.music.play(loops=<span class="hljs-number">-1</span>)</code></pre>
<h2>Final code</h2>
<p><a href="https://www.patternsgameprog.com/discover-python-and-patterns-27-music-and-sounds/discover_python_and_patterns_27_music_and_sounds.zip">Download code and assets</a></p>
<p>In the <a href="https://www.patternsgameprog.com/turn-a-python-pygame-program-to-a-standalone-executable-and-create-an-installer/">next post</a>, we'll see how to package our game so that anyone can run it!</p>
	<!-- Begin Footer
	================================================== -->
	<div class="footer">
		<p class="pull-left">
			 Copyright &copy; 2020-2023 https://www.patternsgameprog.com
		</p>
		<p class="pull-right">
			<a href="https://twitter.com/umlgameprog?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @umlgameprog</a></script>
		</p>
		<div class="clearfix">
		</div>
	</div>
	<!-- End Footer
	================================================== -->

</div>
<!-- /.container -->

<!-- Bootstrap core JavaScript
    ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://www.patternsgameprog.com/assets/js/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://www.patternsgameprog.com/assets/js/bootstrap.min.js"></script>
<script src="https://www.patternsgameprog.com/assets/js/ie10-viewport-bug-workaround.js"></script>
<script src="https://www.patternsgameprog.com/assets/js/mediumish.js"></script>
</body>
</html>